extends ../../base

block mainContent
  .container.mt-5
    h1.text-center.mb-4 A/Bテスト結果
    .text-right.mb-3
      a.btn.btn-primary(href="/dashboard/app/create-ab-test") 新規作成

    //- フィルタリングフォーム
    form#filterForm(method="GET" action="/app/ab-test-results")
      .form-row.align-items-end
        .form-group.col-md-4
          label(for="affiliateId") アフィリエイトIDでフィルタ
          input#affiliateId.form-control(type="text" name="affiliateId" placeholder="アフィリエイトIDを入力（任意）" value=affiliateId)
        .form-group.col-md-2
          button.btn.btn-secondary(type="submit") フィルタ

    //- 結果表示テーブル
    if results.length > 0
      .table-responsive
        table.table.table-bordered.table-hover.mt-4
          thead.thead-dark
            tr
              th.scope.col 作成日
              th.scope.col アフィリエイト名
              th.scope.col バリアントA
              th.scope.col バリアントB
              th.scope.col クリック数
              th.scope.col 表示数
              th.scope.col アクション
          tbody
            each test in results
              tr
                td= new Date(test.uploadDate).toLocaleDateString('ja-JP')
                td= test.affiliateName
                td
                  ul
                    each image in test.images
                      li
                        | #{image.variant}: #{image.imageName}
                        br
                        img(src=image.imageUrl, width="100", alt=`${image.imageName}の画像`)
                td
                  ul
                    each image in test.images
                      li
                        a(href=image.targetUrl, target="_blank") #{image.targetUrl}
                td= test.totalClicks
                td= test.totalViews
                td
                  //- Activate/Deactivate Switch
                  label.switch
                    input(type="checkbox" class="activate-toggle" data-test-id=test.testId checked=(test.active ? 'checked' : undefined))
                    span.slider.round

                  //- Delete Button
                  button.btn.btn-danger.btn-sm.delete-button.mt-2(type="button" data-test-id=test.testId) 削除
    else
      .alert.alert-info.mt-4(role="alert")
        | 指定された条件に一致するA/Bテスト結果が見つかりませんでした。

  script.
    document.addEventListener('DOMContentLoaded', () => {
      // Handle Activate/Deactivate Toggle
      document.querySelectorAll('.activate-toggle').forEach(toggle => {
        toggle.addEventListener('change', async (event) => {
          const testId = event.target.getAttribute('data-test-id');
          const isActive = event.target.checked;

          try {
            const response = await fetch(`/api/abtest/activate-test`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ testId, active: isActive })
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to update status.');
            }
            // Optionally, show a success message
            alert(`A/Bテストは${isActive ? 'アクティブ' : '非アクティブ'}に設定されました。`);
          } catch (error) {
            alert(`エラー: ${error.message}`);
            // Revert the toggle if there's an error
            event.target.checked = !isActive;
          }
        });
      });

      // Handle Delete Button
      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', async (event) => {
          const testId = event.target.getAttribute('data-test-id');
          if (!confirm('本当にこのA/Bテストを削除しますか？')) return;

          try {
            const response = await fetch(`/api/abtest/delete-ab-test/${testId}`, {
              method: 'DELETE'
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to delete A/B test.');
            }
            // Optionally, reload the page or remove the row from the table
            // For simplicity, reload the page
            alert('A/Bテストが正常に削除されました。');
            location.reload();
          } catch (error) {
            alert(`エラー: ${error.message}`);
          }
        });
      });
    });
