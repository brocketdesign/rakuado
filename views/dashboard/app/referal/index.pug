extends ../../base

block mainContent
  .container.mt-5
    h1.text-center.mb-4
      i.bi.bi-people-fill.me-2
      | リファラルポップアップ管理

    .row.mb-4
      .col-12
        .card.shadow-sm
          .card-header.bg-dark.text-white.d-flex.justify-content-between.align-items-center
            span
              i.bi.bi-list-ol.me-2
              | ポップアップ順序管理
            button.btn.btn-primary.btn-sm#btnNewPopup(type="button")
              i.bi.bi-plus-circle.me-1
              | 新規作成
          .card-body
            form#orderForm
              table.table.table-hover.align-middle
                thead
                  tr
                    th(style="width: 60px") 
                      i.bi.bi-arrows-move.me-1
                      | 表示順
                    th 画像
                    th ターゲットURL
                    th 表示数
                    th クリック数
                    th 操作
                tbody#popupTableBody
                  each popup, idx in popups
                    tr(data-popup=popup.popup)
                      td
                        span.handle(style="cursor:move;")
                          i.bi.bi-arrows-move.me-1
                        span.order-number #{popup.order}
                        input(type="hidden" name="popup[]" value=popup.popup)
                      td
                        if popup.imageUrl
                          img(src=popup.imageUrl alt="画像" width="60" class="rounded shadow-sm")
                        else
                          span.text-muted 画像なし
                      td
                        a(href=popup.targetUrl target="_blank" class="text-decoration-none")
                          i.bi.bi-link-45deg.me-1
                          | #{popup.targetUrl}
                      td #{popup.views || 0}
                      td #{popup.clicks || 0}
                      td.d-flex.align-items-center
                        button.btn.btn-outline-secondary.btn-sm.me-1.btn-toggle-domain(type="button" data-popup=popup.popup title="ドメイン別統計を表示")
                          i.bi.bi-chevron-down
                        button.btn.btn-outline-primary.btn-sm.me-1.btn-edit(type="button" data-popup=popup.popup title="編集")
                          i.bi.bi-pencil-square
                        button.btn.btn-outline-danger.btn-sm.btn-delete(type="button" data-popup=popup.popup title="削除")
                          i.bi.bi-trash
                    //- Accordion row (hidden by default)
                    tr.domain-stats-row(style="display:none;" data-popup=popup.popup)
                      td(colspan="6")
                        .domain-stats-content.text-center.py-3
                          .spinner-border.text-secondary(role="status")
                            span.visually-hidden 読み込み中...
              .mt-3.text-end
                button.btn.btn-success(type="submit")
                  i.bi.bi-save.me-1
                  | 順序を保存

  //- Modal for Add/Edit Popup
  .modal.fade#popupModal(tabindex="-1" aria-labelledby="popupModalLabel" aria-hidden="true")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title#popupModalLabel ポップアップ追加・編集
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        .modal-body
          form#popupForm(enctype="multipart/form-data")
            input(type="hidden" name="popup" id="popupId")
            .mb-3
              label.form-label(for="image") 画像アップロード
              input.form-control(type="file" name="image" id="image" accept="image/*")
              input(type="hidden" name="imageUrl" id="imageUrl")
              .mt-2#currentImage
            .mb-3
              label.form-label(for="targetUrl") ターゲットURL
              input.form-control(type="text" name="targetUrl" id="targetUrl")
            button.btn.btn-primary(type="submit")
              i.bi.bi-check-lg.me-1
              | 保存

  //- Ensure jQuery UI is loaded for sortable
  script(src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js")
  link(rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css")

  script.
    $(function() {
      // Enable drag-and-drop sorting
      $('#popupTableBody').sortable({
        handle: '.handle',
        axis: 'y',
        update: function(event, ui) {
          // Update order numbers after sorting
          $('#popupTableBody tr').each(function(index) {
            $(this).find('.order-number').text(index + 1);
          });
        }
      });

      // Open modal for new popup
      $('#btnNewPopup').on('click', function() {
        $('#popupModalLabel').text('ポップアップ追加');
        $('#popupForm')[0].reset();
        $('#popupId').val('');
        $('#imageUrl').val('');
        $('#currentImage').html('');
        $('#popupModal').modal('show');
      });

      // Edit popup
      $('.btn-edit').on('click', function() {
        const popup = $(this).data('popup');
        $.get('/api/referal/info', { popup }, function(data) {
          $('#popupModalLabel').text('ポップアップ編集');
          $('#popupId').val(popup);
          $('#targetUrl').val(data.targetUrl || '');
          $('#imageUrl').val(data.imageUrl || '');
          if (data.imageUrl) {
            $('#currentImage').html('<img src="'+data.imageUrl+'" alt="現在の画像" width="100" class="rounded shadow-sm"/>');
          } else {
            $('#currentImage').html('');
          }
          $('#image').val('');
          $('#popupModal').modal('show');
        }).fail(function() {
          Swal.fire('エラー', '情報の取得に失敗しました', 'error');
        });
      });

      // Delete popup
      $('.btn-delete').on('click', function() {
        const popup = $(this).data('popup');
        Swal.fire({
          title: '削除しますか？',
          text: 'このポップアップを削除します。よろしいですか？',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'はい、削除',
          cancelButtonText: 'キャンセル'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: '/api/referal/' + popup,
              type: 'DELETE',
              success: function() {
                Swal.fire('削除しました', '', 'success').then(() => location.reload());
              },
              error: function() {
                Swal.fire('エラー', '削除に失敗しました', 'error');
              }
            });
          }
        });
      });

      // Save popup (add/edit)
      $('#popupForm').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
          url: '/api/referal/save',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function() {
            $('#popupModal').modal('hide');
            Swal.fire('保存しました', '', 'success').then(() => location.reload());
          },
          error: function(xhr) {
            let msg = '保存に失敗しました';
            if (xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
            Swal.fire('エラー', msg, 'error');
          }
        });
      });

      // Save order
      $('#orderForm').on('submit', function(e) {
        e.preventDefault();
        // Build popup[] and order[] arrays based on current row order
        var popupArr = [];
        var orderArr = [];
        $('#popupTableBody tr').each(function(index) {
          popupArr.push($(this).data('popup'));
          orderArr.push(index + 1);
        });
        $.post('/api/referal/order', { popup: popupArr, order: orderArr })
          .done(function() {
            Swal.fire('順序を保存しました', '', 'success').then(() => location.reload());
          })
          .fail(function() {
            Swal.fire('エラー', '順序の保存に失敗しました', 'error');
          });
      });

      // Accordion toggle for domain stats
      $('#popupTableBody').on('click', '.btn-toggle-domain', function() {
        var $btn = $(this);
        var popup = $btn.data('popup');
        var $row = $btn.closest('tr');
        var $accordion = $row.next('.domain-stats-row');
        if ($accordion.is(':visible')) {
          $accordion.hide();
          $btn.find('i').removeClass('bi-chevron-up').addClass('bi-chevron-down');
          return;
        }
        // Hide any other open accordions
        $('.domain-stats-row').hide();
        $('.btn-toggle-domain i').removeClass('bi-chevron-up').addClass('bi-chevron-down');
        $accordion.show();
        $btn.find('i').removeClass('bi-chevron-down').addClass('bi-chevron-up');
        // If not loaded yet, fetch domain stats
        var $content = $accordion.find('.domain-stats-content');
        $content.html('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">読み込み中...</span></div>');
        $.get('/api/referal/info', { popup }, function(data) {
          if (!data.refery || !data.refery.length) {
            $content.html('<div class="text-muted">ドメイン別の統計データはありません。</div>');
            return;
          }
          var html = '<table class="table table-sm table-bordered mb-0"><thead><tr><th>ドメイン</th><th>表示数</th><th>クリック数</th></tr></thead><tbody>';
          data.refery.forEach(function(r) {
            html += '<tr><td>' + $('<div>').text(r.domain).html() + '</td><td>' + (r.view || 0) + '</td><td>' + (r.click || 0) + '</td></tr>';
          });
          html += '</tbody></table>';
          $content.html(html);
        }).fail(function() {
          $content.html('<div class="text-danger">統計データの取得に失敗しました。</div>');
        });
      });
    });
    // jQuery UI sortable required
