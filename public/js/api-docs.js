// API Documentation - Markdown generation and copy functionality
(function() {
  const baseUrl = window.location.origin;

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('baseUrlDisplay').textContent = baseUrl + '/api/v1';

    // Copy full docs
    document.getElementById('copyAllDocsBtn').addEventListener('click', function() {
      navigator.clipboard.writeText(getFullMarkdown()).then(function() {
        showCopyToast();
      });
    });

    // Copy section buttons
    document.querySelectorAll('.copy-section-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var section = btn.getAttribute('data-section');
        var md = getSectionMarkdown(section);
        navigator.clipboard.writeText(md).then(function() {
          showCopyToast();
        });
      });
    });
  });

  function getFullMarkdown() {
    var lines = [
      '# Rakuado API Documentation',
      '',
      '## Base URL',
      '`' + baseUrl + '/api/v1`',
      '',
      '## Authentication',
      'All requests require an API key. Pass it via:',
      '- **Header (recommended):** `x-api-key: YOUR_API_KEY`',
      '- **Query parameter:** `?api_key=YOUR_API_KEY`',
      '',
      '---',
      '',
      '## Affiliates',
      '',
      '### List Affiliates',
      '```',
      'GET /api/v1/affiliates',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| limit | number | Max results (default: 50) |',
      '| offset | number | Skip results (default: 0) |',
      '| domain | string | Filter by domain (partial match) |',
      '| isActive | boolean | Filter by active status |',
      '',
      '### Get Affiliate',
      '```',
      'GET /api/v1/affiliates/:id',
      '```',
      '',
      '### Create Affiliate',
      '```',
      'POST /api/v1/affiliates',
      '```',
      '**Body:**',
      '| Name | Type | Required | Description |',
      '|------|------|----------|-------------|',
      '| wordpressUrl | string | yes | Full WordPress URL |',
      '| name | string | no | Display name |',
      '| isActive | boolean | no | Active status (default: true) |',
      '',
      '### Update Affiliate',
      '```',
      'PUT /api/v1/affiliates/:id',
      '```',
      '',
      '### Delete Affiliate',
      '```',
      'DELETE /api/v1/affiliates/:id',
      '```',
      '',
      '### Get Affiliate Clicks Today',
      '```',
      'GET /api/v1/affiliates/:id/clicks/today',
      '```',
      'Returns daily and monthly click/view counts.',
      '',
      '### Get Affiliate Clicks Over Range',
      '```',
      'GET /api/v1/affiliates/:id/clicks/range',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| startDate | string | Start date YYYY-MM-DD (required) |',
      '| endDate | string | End date YYYY-MM-DD (required) |',
      '| action | string | "click" or "view" (default: "click") |',
      '',
      '### Get Affiliate Stats',
      '```',
      'GET /api/v1/affiliates/:id/stats',
      '```',
      'Returns 6-month breakdown of clicks and views.',
      '',
      '---',
      '',
      '## Websites',
      '',
      '### List Websites',
      '```',
      'GET /api/v1/websites',
      '```',
      'Returns all tracked websites with latest analytics and affiliate association.',
      '',
      '### Get Website Analytics',
      '```',
      'GET /api/v1/websites/:domain/analytics',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| period | string | "current" or "previous" (default: "current") |',
      '',
      '---',
      '',
      '## Analytics',
      '',
      '### Get Analytics Summary',
      '```',
      'GET /api/v1/analytics/summary',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| period | string | "current" or "previous" (default: "current"). Uses custom 21st-to-20th monthly periods. |',
      '',
      '### Get Daily Analytics',
      '```',
      'GET /api/v1/analytics/daily',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| startDate | string | Start date YYYY-MM-DD (required) |',
      '| endDate | string | End date YYYY-MM-DD (required) |',
      '| site | string | Filter by site domain (default: "all") |',
      '',
      '### Get Tracked Sites',
      '```',
      'GET /api/v1/analytics/sites',
      '```',
      '',
      '---',
      '',
      '## Partners',
      '',
      '### List Partners',
      '```',
      'GET /api/v1/partners',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| status | string | Filter: active, stopped, pending, inactive |',
      '| limit | number | Max results (default: 50) |',
      '| offset | number | Skip results (default: 0) |',
      '',
      '### Get Partner',
      '```',
      'GET /api/v1/partners/:id',
      '```',
      '',
      '### Create Partner',
      '```',
      'POST /api/v1/partners',
      '```',
      '**Body:**',
      '| Name | Type | Required | Description |',
      '|------|------|----------|-------------|',
      '| domain | string | yes | Partner website domain |',
      '| name | string | yes | Partner name |',
      '| monthlyAmount | number | yes | Monthly payment (JPY) |',
      '| startDate | string | yes | Start date (YYYY-MM-DD) |',
      '| paymentCycle | string | no | Payment cycle (default: "当月") |',
      '| email | string | no | Contact email |',
      '| bankName | string | no | Bank name |',
      '| bankBranch | string | no | Bank branch |',
      '| accountType | string | no | Account type (default: "普通") |',
      '| accountNumber | string | no | Account number |',
      '| accountHolder | string | no | Account holder name |',
      '',
      '### Update Partner',
      '```',
      'PUT /api/v1/partners/:id',
      '```',
      '',
      '### Delete Partner',
      '```',
      'DELETE /api/v1/partners/:id',
      '```',
      '',
      '### Calculate Partner Payments',
      '```',
      'GET /api/v1/partners/payments/calculate',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| period | string | "current" or "previous" (default: "current") |',
      '',
      'Pro-rated payments based on analytics active days within the custom 21st-to-20th period.',
      '',
      '---',
      '',
      '## Partner Recruitment',
      '',
      '### List Partner Requests',
      '```',
      'GET /api/v1/partner-requests',
      '```',
      '**Query Parameters:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| status | string | Filter: submitted, analytics_requested, reviewing, approved, snippet_sent, snippet_verified, rejected |',
      '| limit | number | Max results (default: 50) |',
      '| offset | number | Skip results (default: 0) |',
      '',
      '### Get Partner Request',
      '```',
      'GET /api/v1/partner-requests/:id',
      '```',
      '',
      '### Update Partner Request',
      '```',
      'PUT /api/v1/partner-requests/:id',
      '```',
      '**Body:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| currentStep | string | Current workflow step |',
      '| status | string | Request status |',
      '| googleAnalyticsUrl | string | Google Analytics URL |',
      '| estimatedMonthlyAmount | number | Estimated monthly payment |',
      '| notes | string | Internal notes |',
      '',
      '### Approve Partner Request',
      '```',
      'POST /api/v1/partner-requests/:id/approve',
      '```',
      '',
      '### Reject Partner Request',
      '```',
      'POST /api/v1/partner-requests/:id/reject',
      '```',
      '**Body:**',
      '| Name | Type | Description |',
      '|------|------|-------------|',
      '| reason | string | Optional rejection reason |',
      '',
      '---',
      '',
      '## Referral Popups',
      '',
      '### List Popups',
      '```',
      'GET /api/v1/popups',
      '```',
      'Returns all referral popups with 24h views and clicks.',
      '',
      '---',
      '',
      '## Error Codes',
      '| Status | Meaning | Description |',
      '|--------|---------|-------------|',
      '| 200 | OK | Success |',
      '| 201 | Created | Resource created |',
      '| 400 | Bad Request | Invalid parameters |',
      '| 401 | Unauthorized | Invalid API key |',
      '| 404 | Not Found | Resource not found |',
      '| 500 | Server Error | Internal error |',
    ];
    return lines.join('\n');
  }

  function getSectionMarkdown(section) {
    var full = getFullMarkdown();
    var sections = {
      auth: /## Authentication[\s\S]*?(?=\n---)/,
      affiliates: /## Affiliates[\s\S]*?(?=\n---\n\n## Websites)/,
      websites: /## Websites[\s\S]*?(?=\n---\n\n## Analytics)/,
      analytics: /## Analytics[\s\S]*?(?=\n---\n\n## Partners\b)/,
      partners: /## Partners[\s\S]*?(?=\n---\n\n## Partner Recruitment)/,
      recruitment: /## Partner Recruitment[\s\S]*?(?=\n---\n\n## Referral)/,
      popups: /## Referral Popups[\s\S]*?(?=\n---\n\n## Error)/
    };
    var match = full.match(sections[section]);
    if (match) {
      var title = section.charAt(0).toUpperCase() + section.slice(1);
      return '# Rakuado API \u2014 ' + title + '\n\nBase URL: `' + baseUrl + '/api/v1`\nAuth: `x-api-key: YOUR_API_KEY` header\n\n' + match[0];
    }
    return full;
  }

  function showCopyToast() {
    var toast = document.getElementById('copyToast');
    toast.style.display = 'block';
    setTimeout(function() { toast.style.display = 'none'; }, 3000);
  }
})();
